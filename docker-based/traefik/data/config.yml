# using traefik for workloads outside containers (configuration)
# see more services here: https://github.com/techno-tim/techno-tim.github.io/blob/master/reference_files/traefik-portainer-ssl/traefik/config.yml
http:
  # routers:
  #   proxmox:
  #     entryPoints:
  #       - "https"
  #     rule: "Host(`proxmox.local.ejsadiarin.com`)"
  #     middlewares:
  #       - default-headers
  #       - https-redirectscheme
  #     tls: {}
  #     service: proxmox
  #   pihole:
  
  # services:
  #   proxmox:
  #     loadBalancer:
  #       servers:
  #         - url: "https://192.168.0.17:8006"
  #         # - url: "https://192.168.0.17:8006"
  #       passHostHeader: true

  middlewares:
    https-redirectscheme:
      redirectScheme:
        scheme: https
        permanent: true

    default-headers:
      headers:
        frameDeny: false
        # frameDeny: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 15552000
        customFrameOptionsValue: SAMEORIGIN
        customRequestHeaders:
          X-Forwarded-Proto: https
          # handled by frameDeny:
          # Content-Security-Policy: "frame-ancestors 'self' https://*.local.ejsadiarin.com;"

    default-whitelist:
      ipAllowList:
        sourceRange: # might want to just allow the private subnet proxmox is on/using (if tailscale then 100.64.0.0/10 range)
        - "10.0.0.0/8"
        - "192.168.0.0/16"
        - "172.16.0.0/12"
        - "100.64.0.0/10"

    secured:
      chain:
        middlewares:
        - default-whitelist
        - default-headers

    authentik:
      forwardAuth:
        address: http://authentik-server:9000/outpost.goauthentik.io/auth/traefik
        trustForwardHeader: true
        authResponseHeaders:
          - X-authentik-username
          - X-authentik-groups
          - X-authentik-email
          - X-authentik-name
          - X-authentik-uid
          - X-authentik-jwt
          - X-authentik-meta-jwks
          - X-authentik-meta-outpost
          - X-authentik-meta-provider
          - X-authentik-meta-app
          - X-authentik-meta-version

    allow-iframe:
      headers:
        contentSecurityPolicy: "frame-ancestors 'self' https://*.local.ejsadiarin.com;"
        # customRequestHeaders:
        #   X-Forwarded-Proto: https
        #   # handled by frameDeny:
        #   # Content-Security-Policy: "frame-ancestors 'self' https://*.local.ejsadiarin.com;"
