# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/refs/heads/main/argoproj.io/applicationset_v1alpha1.json
---
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cluster-infrastructure
  namespace: argocd

spec:
  generators:
    - git:
        repoURL: 'https://github.com/ejsadiarin/core-k8s-homelab.git'
        revision: k8s
        directories:
          - path: cluster/core/*
  template:
    metadata:
      name: '{{path.basename}}-bootstrap'
      # annotations:
      # argocd.argoproj.io/sync-wave: "0" # Individual apps should set their own sync-wave
    spec:
      project: default
      source:
        repoURL: 'https://github.com/ejsadiarin/core-k8s-homelab.git'
        targetRevision: k8s
        path: '{{path}}'
      destination:
        server: 'https://kubernetes.default.svc'
        # Namespace will be determined by the app.yaml inside each component folder
        namespace: 'argocd'
      syncPolicy:
        automated: {prune: true, selfHeal: true}
        syncOptions: [CreateNamespace=true] # Let individual apps decide if they need CreateNamespace=true
---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/refs/heads/main/argoproj.io/applicationset_v1alpha1.json
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: cluster-apps
  namespace: argocd

spec:
  generators:
    - git:
        repoURL: 'https://github.com/ejsadiarin/core-k8s-homelab.git'
        revision: k8s
        directories:
          - path: apps/production/*
  template:
    metadata:
      name: '{{path.basename}}'
      namespace: argocd
    spec:
      project: default
      source:
        repoURL: 'https://github.com/ejsadiarin/core-k8s-homelab.git'
        targetRevision: k8s
        path: '{{path}}'
      destination:
        server: 'https://kubernetes.default.svc'
        namespace: '{{path.basename}}' # Creates a namespace based on the directory name
      syncPolicy:
        automated: {prune: true, selfHeal: true}
        syncOptions: [CreateNamespace=true]
